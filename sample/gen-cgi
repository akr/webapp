#!/usr/bin/env ruby

require 'rbconfig'
require 'pathname'

RUBY = "#{Config::CONFIG["bindir"]}/#{Config::CONFIG["ruby_install_name"]}"
OUTPUT_DIR = "cgi-bin"

Dir.mkdir OUTPUT_DIR unless File.directory? OUTPUT_DIR

ARGV.each {|script_name|
  script_abspath = Pathname.new(script_name).realpath
  open("#{OUTPUT_DIR}/#{script_name}", 'w') {|f|
    f << <<"End"
#!#{RUBY}

# This file is auto-generated stub file.  Don't edit.

script_abspath = #{script_abspath.to_s.dump}

script_dir = File.dirname(script_abspath)
Dir.chdir script_dir
$:.replace [script_dir] | $:
$:.delete '.'
require 'webapp'
WebApp.run_webapp_via_stub(script_abspath)
End
    f.chmod 0755
  }
}
